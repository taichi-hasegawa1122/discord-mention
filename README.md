# Discord メンション数ランキング

特定のDiscordサーバーでメンションされた回数を集計し、ランキング形式で表示するWebアプリケーションです。

## 機能

- Discordサーバー内のメンション数を自動集計
- ユーザー別のランキング表示
- リアルタイムでの接続状態確認
- モダンでレスポンシブなUI

## セットアップ

### 1. Discord Botの作成（詳細手順）

#### ステップ1: Discord Developer Portalにアクセス

1. ブラウザで [Discord Developer Portal](https://discord.com/developers/applications) を開く
2. Discordアカウントでログイン（まだアカウントがない場合は作成が必要です）

#### ステップ2: 新しいアプリケーションを作成

1. 右上の「New Application」ボタンをクリック
2. アプリケーション名を入力（例: "メンション数カウントBot"）
3. 「Create」をクリック

#### ステップ3: Botを作成

1. 左サイドバーから「Bot」をクリック
2. 「Add Bot」ボタンをクリック
3. 確認ダイアログで「Yes, do it!」をクリック

#### ステップ4: Bot Tokenを取得

1. 「Token」セクションまでスクロール
2. 「Reset Token」ボタンをクリック
3. 確認ダイアログで「Yes, do it!」をクリック
4. **重要**: 表示されたトークンをコピーして安全な場所に保存してください
   - このトークンは後で`.env`ファイルに設定します
   - トークンは他人に見せないでください（セキュリティ上重要）

#### ステップ5: 必要な権限（Intents）を有効化 ⚠️ 重要

1. 「Privileged Gateway Intents」セクションまでスクロール
2. 以下のチェックボックスを**必ず有効化**してください：
   - ✅ **MESSAGE CONTENT INTENT**（必須 - メッセージの内容を読み取るために必要）
   - ✅ **SERVER MEMBERS INTENT**（推奨 - サーバーメンバー情報を取得するために必要）
3. **変更を保存**（自動保存される場合もありますが、確認してください）

**重要**: Intentsを有効化しないと「Used disallowed intents」エラーが発生します。

### 2. Botをサーバーに招待（詳細手順）

#### ステップ1: OAuth2 URL Generatorを開く

1. 左サイドバーから「OAuth2」をクリック
2. 「URL Generator」をクリック

#### ステップ2: Scopes（スコープ）を選択

1. 「Scopes」セクションで以下を選択：
   - ✅ **bot**（必須）

#### ステップ3: Bot Permissions（権限）を選択

1. 「Bot Permissions」セクションで以下を選択：
   - ✅ **Read Messages/View Channels**（チャンネルとメッセージを表示）
   - ✅ **Read Message History**（メッセージ履歴を読む）

**注意**: 他の権限は不要です。最小限の権限のみを付与することを推奨します。

#### ステップ4: 招待URLを生成して使用

1. ページ下部の「Generated URL」に招待URLが自動生成されます
2. このURLをコピー
3. ブラウザの新しいタブでこのURLを開く
4. 以下の手順でBotを招待：
   - 招待したいDiscordサーバーを選択
   - 「認証」または「Authorize」をクリック
   - キャプチャ（人間かどうかの確認）を完了
   - 「サーバーに追加」をクリック
5. Botがサーバーに追加されたことを確認（サーバーのメンバーリストにBotが表示されます）

**重要**: Botを招待するには、そのサーバーで「サーバー管理」または「管理者」権限が必要です。

### 3. プロジェクトのセットアップ

#### ステップ1: 依存関係をインストール

プロジェクトのディレクトリで以下のコマンドを実行：

```bash
npm install
```

#### ステップ2: 環境変数ファイル（.env）を作成

プロジェクトのルートディレクトリに`.env`ファイルを作成します。

**方法1: コマンドラインで作成**
```bash
# .env.exampleをコピー（存在する場合）
cp .env.example .env

# または直接作成
touch .env
```

**方法2: 手動で作成**
1. プロジェクトのルートディレクトリに`.env`という名前のファイルを作成
2. 以下の内容を記述：

```
DISCORD_TOKEN=ここに先ほど取得したBot Tokenを貼り付け
PORT=3000
```

**例:**
```
DISCORD_TOKEN=MTIzNDU2Nzg5MDEyMzQ1Njc4OTAxMjM0NTY3ODkwMTIzNDU2Nzg5MA.GaBcDe.FgHiJkLmNoPqRsTuVwXyZaBcDeFgHiJkLmNoPqRsTuVw
PORT=3000
```

**重要**: 
- `DISCORD_TOKEN=`の後に、ステップ4で取得したBot Tokenを貼り付けます
- トークンの前後に余分なスペースや引用符を入れないでください
- `.env`ファイルはGitにコミットしないでください（既に`.gitignore`に追加済み）

### 4. サーバーの起動

**簡単な方法（推奨）:**

macOSの場合、`start.command`ファイルをダブルクリックするだけで起動できます：
1. Finderで`start.command`ファイルを見つける
2. ダブルクリック
3. ブラウザが自動で開きます

**手動で起動する場合:**

```bash
# 開発モード（自動リロード）
npm run dev

# または本番モード
npm start
```

サーバーが起動したら、ブラウザで `http://localhost:3000` にアクセスしてください。

**注意**: サーバーを停止するには、ターミナルウィンドウで `Ctrl+C` を押してください。

## 使い方

1. `start.command`をダブルクリックしてサーバーを起動（または`npm start`を実行）
2. ブラウザでアプリケーションが自動で開きます（`http://localhost:3000`）
3. 接続状態が「接続済み」になっていることを確認
4. サーバーリストから集計したいサーバーを選択
5. 「ランキングを取得」ボタンをクリック
6. ランキングが表示されます（処理には時間がかかる場合があります）

**重要**: アプリケーションを使う間は、サーバーを起動したままにしておいてください。

## 注意事項

- 大量のメッセージがあるサーバーでは、ランキング取得に時間がかかる場合があります
- Botはサーバーに参加している必要があります
- Botはメッセージを読み取る権限が必要です
- デフォルトでは最大10,000件のメッセージを取得します（APIエンドポイントの`limit`パラメータで変更可能）

## トラブルシューティング

### Botが接続されない

**症状**: ブラウザで「Discord Botが接続されていません」と表示される

**解決方法**:
1. `.env`ファイルに正しいトークンが設定されているか確認
   - トークンに余分なスペースや改行が入っていないか確認
   - トークンが完全にコピーされているか確認
2. Botがサーバーに招待されているか確認
   - DiscordサーバーのメンバーリストにBotが表示されているか確認
3. Botに必要な権限が付与されているか確認
   - Developer Portalで「MESSAGE CONTENT INTENT」が有効になっているか確認
4. サーバーを再起動
   - `Ctrl+C`でサーバーを停止し、再度`npm start`で起動
5. トークンが無効になっていないか確認
   - Developer Portalでトークンを再生成してみる（その場合は`.env`も更新）

### ランキングが取得できない

**症状**: 「ランキングを取得」ボタンを押してもエラーが出る、またはデータが表示されない

**解決方法**:
1. Botがサーバーに参加しているか確認
   - サーバーのメンバーリストでBotの存在を確認
2. Botに「メッセージ履歴を読む」権限があるか確認
   - サーバー設定 → ロール → Botのロールで権限を確認
   - 必要に応じてBotを再招待（正しい権限を選択）
3. Botがチャンネルにアクセスできるか確認
   - プライベートチャンネルの場合、Botのロールにアクセス権限が必要
4. サーバーにメッセージが存在するか確認
   - メッセージがない、またはメンションがない場合はランキングが空になります

### その他のよくある問題

**問題**: 「サーバーが見つかりません」エラー

**解決方法**:
- サーバーIDが正しいか確認
- Botがそのサーバーに参加しているか確認

**問題**: ランキング取得に時間がかかりすぎる

**解決方法**:
- 大量のメッセージがあるサーバーでは処理に時間がかかります
- ブラウザのコンソールでエラーが出ていないか確認
- サーバーのログを確認してエラーがないか確認

**問題**: 一部のユーザーがランキングに表示されない

**解決方法**:
- ボットは自動的に除外されます（これは正常な動作です）
- サーバーから退出したユーザーは表示されない場合があります

## ライセンス

MIT

